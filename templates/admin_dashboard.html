{% extends "base.html" %}

{% block title %}Dashboard Admin{% endblock %}

{% block content %}
<div class="space-y-8">
    <h2 class="text-4xl font-extrabold text-gray-900 border-b pb-2">Tableau de Bord Administrateur</h2>

    <p class="text-gray-600">Bienvenue, <strong class="text-blue-600">{{ admin_username }}</strong></p>

    <div id="status-alerts">
        {% if message %}
        <div class="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded relative mb-4" role="alert">
            <strong class="font-bold">Succ√®s !</strong>
            <span class="block sm:inline">{{ message }}</span>
        </div>
        {% endif %}

        {% if error %}
        <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative mb-4" role="alert">
            <strong class="font-bold">Erreur :</strong>
            <span class="block sm:inline">{{ error }}</span>
        </div>
        {% endif %}
    </div>

    <div class="card p-6 bg-yellow-50 border-yellow-300 border-l-4">
        <h3 class="text-2xl font-semibold mb-4 text-gray-700">0. Gestion de la Liste d'√âligibilit√© (Whitelist)</h3>
        <p class="text-sm text-gray-600 mb-4">
            T√©l√©chargez un fichier Excel (.xlsx ou .xls) contenant les colonnes exactes : **Nom, Prenom, Parcours**. Cette liste est OBLIGATOIRE pour l'inscription des √©tudiants.
        </p>
        
        <form id="whitelistUploadForm" enctype="multipart/form-data">
            <div class="flex items-center space-x-4">
                <input type="file" id="excel_file" name="excel_file" accept=".xlsx, .xls" required
                       class="flex-grow p-2 border border-gray-300 rounded file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100">
                <button type="submit" id="uploadButton"
                        class="btn-primary bg-indigo-600 hover:bg-indigo-700 px-6 py-3 font-bold">
                    Importer et R√©initialiser la Liste
                </button>
            </div>
        </form>

        <div id="uploadMessage" class="mt-4"></div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-center pt-6 mt-6 border-t border-gray-200">
            <div class="p-4 bg-yellow-100 rounded-lg">
                <p class="text-4xl font-extrabold text-yellow-800">{{ total_eligible }}</p>
                <p class="text-gray-600">Total √âtudiants √âligibles (Whitelist)</p>
            </div>
            <div class="p-4 bg-yellow-100 rounded-lg">
                <p class="text-4xl font-extrabold text-yellow-800">{{ eligible_to_register }}</p>
                <p class="text-gray-600">En attente d'inscription</p>
            </div>
            <div class="p-4 bg-yellow-100 rounded-lg">
                <p class="text-4xl font-extrabold text-yellow-800">{{ total_students_voters }}</p>
                <p class="text-gray-600">Total Votants Inscrits</p>
            </div>
        </div>
    </div>


    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        
        <div class="card p-6 bg-blue-50 border-blue-300 border-l-4 lg:col-span-1">
            <h3 class="text-2xl font-semibold mb-4 text-gray-800">1. Statut Global de l'√âlection ‚öôÔ∏è</h3>
            
            <p class="text-lg font-bold text-gray-700 mb-2">Statut Actuel: <strong id="current_election_status" 
                class="{% if SETTINGS.election_status == 'VOTING' %}text-green-600{% elif SETTINGS.election_status == 'CLOSED' %}text-red-600{% else %}text-orange-600{% endif %}">
                {{ SETTINGS.election_status }} 
            </strong></p>
            
            <p class="text-gray-600 mb-6">Contr√¥le de l'√©tat g√©n√©ral du scrutin.</p>

            <div class="space-y-4">
                {% if SETTINGS.election_status == 'SETUP' %}
                    <button onclick="toggleVoting('open_voting')" class="btn-primary bg-green-600 hover:bg-green-700 w-full font-bold">
                        OUVRIR le Vote (Lancer l'√âlection)
                    </button>
                {% elif SETTINGS.election_status == 'VOTING' %}
                    <button onclick="toggleVoting('finalise_election')" class="btn-primary bg-red-700 hover:bg-red-800 w-full font-bold">
                        FINALISER l'√âlection (Cl√¥ture D√©finitive)
                    </button>
                {% else %}
                    <p class="text-sm text-red-600 font-semibold text-center">√âlection cl√¥tur√©e. Impossible de rouvrir.</p>
                {% endif %}
            </div>

            <div class="mt-6 pt-4 border-t border-gray-200">
                <h4 class="text-xl font-semibold mb-2 text-gray-700">Visibilit√© des R√©sultats</h4>
                <p class="text-gray-600 mb-4">Statut: <strong id="current_results_visibility" class="{% if SETTINGS.results_visibility == 'VISIBLE' %}text-green-600{% else %}text-red-600{% endif %}">
                    {{ SETTINGS.results_visibility }}
                </strong></p>
                {% if SETTINGS.results_visibility == 'HIDDEN' %}
                <button onclick="toggleVoting('toggle_results_visibility')" class="btn-primary bg-green-600 hover:bg-green-700 w-full">
                    Rendre VISIBLES
                </button>
                {% else %}
                <button onclick="toggleVoting('toggle_results_visibility')" class="btn-primary bg-red-600 hover:bg-red-700 w-full">
                    Rendre CACH√âS
                </button>
                {% endif %}
            </div>

            <div class="mt-6 pt-4 border-t border-gray-200">
                <h4 class="text-xl font-semibold mb-2 text-gray-700">Candidature (Auto-Inscription)</h4>
                <p class="text-gray-600 mb-4">Statut: <strong id="current_candidacy_status" class="{% if SETTINGS.candidacy_open %}text-green-600{% else %}text-red-600{% endif %}">
                    {% if SETTINGS.candidacy_open %}OUVERTE{% else %}FERM√âE{% endif %}
                </strong></p>
                {% if SETTINGS.candidacy_open %}
                <button onclick="toggleVoting('toggle_candidacy_open')" class="btn-primary bg-red-600 hover:bg-red-700 w-full">
                    Fermer l'Inscription
                </button>
                {% else %}
                <button onclick="toggleVoting('toggle_candidacy_open')" class="btn-primary bg-green-600 hover:bg-green-700 w-full">
                    Ouvrir l'Inscription
                </button>
                {% endif %}
            </div>

        </div>

        <div class="card p-6 bg-red-50 border-red-300 border-l-4 lg:col-span-2">
            <h3 class="text-2xl font-semibold mb-4 text-gray-800">2. √âtat du Vote & Stats üó≥Ô∏è</h3>

            <div class="grid grid-cols-2 gap-4 text-center mb-6">
                <div class="p-4 bg-white rounded-lg border">
                    <p class="text-4xl font-extrabold text-red-700">{{ total_students_voters }}</p>
                    <p class="text-gray-600">Total Votants Inscrits</p>
                </div>
                <div class="p-4 bg-white rounded-lg border">
                    <p class="text-4xl font-extrabold text-green-700">{{ total_students_voted }}</p>
                    <p class="text-gray-600">Votants qui ont Vot√©</p>
                </div>
            </div>
            
            <div class="grid grid-cols-2 gap-4 text-center mb-6">
                 <div class="p-4 bg-white rounded-lg border">
                    <p class="text-4xl font-extrabold text-indigo-700">{{ total_votes_cast }}</p>
                    <p class="text-gray-600">Total Votes Enregistr√©s (Blockchain)</p>
                </div>
                <div class="p-4 bg-white rounded-lg border">
                    <p class="text-4xl font-extrabold text-yellow-700">
                        {{ (total_students_voters / total_eligible * 100) | round(2) if total_eligible > 0 else 0 }}%
                    </p>
                    <p class="text-gray-600">Taux Inscription (sur Whitelist)</p>
                </div>
            </div>


            <h4 class="text-xl font-semibold mb-2 pt-4 border-t border-gray-200 text-gray-700">Contr√¥le du Vote (Ouverture/Fermeture Temporaire)</h4>
            <p class="text-sm text-gray-600 mb-4">Statut actuel : <strong id="current_voting_status" 
                class="{% if SETTINGS.voting_status == 'OPEN' %}text-green-600{% else %}text-red-600{% endif %}"> 
                {{ SETTINGS.voting_status }} 
            </strong></p>
            
            <div class="flex space-x-4">
                {% if SETTINGS.election_status == 'VOTING' %}
                    {% if SETTINGS.voting_status == 'OPEN' %}
                    <button onclick="toggleVoting('close_voting')" class="btn-primary bg-red-600 hover:bg-red-700 flex-grow">
                        Clore le Vote Temporairement
                    </button>
                    {% else %}
                    <button onclick="toggleVoting('open_voting')" class="btn-primary bg-green-600 hover:bg-green-700 flex-grow">
                        Ouvrir le Vote
                    </button>
                    {% endif %}
                {% else %}
                    <button disabled class="btn-primary bg-gray-400 flex-grow">
                        Le vote n'est pas encore lanc√© (SETUP)
                    </button>
                {% endif %}
            </div>
        </div>
    </div>


    <div class="card p-6 bg-purple-50 border-purple-300 border-l-4">
        <h3 class="text-2xl font-semibold mb-4 text-gray-800">3. Gestion des Candidats üë§</h3>
        <p class="text-gray-600 mb-4">
            <span class="font-bold text-lg text-purple-700">{{ candidates_waiting }}</span> candidats en attente de validation. | 
            <span class="font-bold text-lg text-green-700">{{ candidates_validated }}</span> candidats valid√©s.
        </p>
        
        <div class="space-y-4">
            {% for cid, candidate in CANDIDATES.items() %}
            <div class="flex items-center p-4 bg-white rounded-lg shadow-sm border {% if candidate.is_validated %}border-green-300{% else %}border-yellow-300{% endif %}">
                <img src="{{ url_for('static', filename='candidate_images/' + candidate.image_filename) }}" 
                     alt="{{ candidate.nom }} {{ candidate.prenom }}" 
                     class="w-12 h-12 rounded-full object-cover mr-4">
                
                <div class="flex-grow">
                    <p class="font-bold text-gray-800">{{ candidate.prenom }} {{ candidate.nom }}</p>
                    <p class="text-sm text-gray-600">{{ candidate.parcours }} - {{ candidate.slogan }}</p>
                </div>
                
                <div class="flex-shrink-0 text-right">
                    {% if candidate.is_validated %}
                        <span class="text-sm font-semibold text-green-600 mr-3">Valid√© ‚úÖ</span>
                        <button onclick="candidateAction('{{ cid }}', 'delete')" class="text-sm text-red-600 hover:text-red-800 font-bold">Supprimer</button>
                    {% else %}
                        <button onclick="candidateAction('{{ cid }}', 'validate')" class="text-sm text-green-600 hover:text-green-800 font-bold mr-3">Valider</button>
                        <button onclick="candidateAction('{{ cid }}', 'delete')" class="text-sm text-red-600 hover:text-red-800 font-bold">Supprimer</button>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        </div>
    </div>

</div>

<script>
    // GESTION UPLOAD WHITELIST
    document.getElementById('whitelistUploadForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        const form = e.target;
        const formData = new FormData(form);
        const uploadButton = document.getElementById('uploadButton');
        const uploadMessageDiv = document.getElementById('uploadMessage');
        
        // √âtat de chargement
        uploadButton.disabled = true;
        uploadButton.textContent = 'Importation en cours...';
        uploadButton.classList.remove('bg-indigo-600', 'hover:bg-indigo-700');
        uploadButton.classList.add('bg-gray-400');

        uploadMessageDiv.innerHTML = '<p class="text-sm text-gray-500">Traitement du fichier, veuillez patienter...</p>';

        try {
            const response = await fetch('/api/admin/upload_whitelist', {
                method: 'POST',
                body: formData
            });

            const data = await response.json();

            if (!response.ok) {
                // Afficher l'erreur
                uploadMessageDiv.innerHTML = `<div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative" role="alert"><strong class="font-bold">Erreur !</strong> <span class="block sm:inline">${data.error || '√âchec de l\'op√©ration.'}</span></div>`;
            } else {
                // Afficher le succ√®s et recharger
                uploadMessageDiv.innerHTML = `<div class="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded relative" role="alert"><strong class="font-bold">Succ√®s !</strong> <span class="block sm:inline">${data.success}</span></div>`;
                // Recharger pour mettre √† jour les statistiques
                setTimeout(() => {
                    window.location.reload(); 
                }, 1000); 
            }

        } catch (error) {
            uploadMessageDiv.innerHTML = `<div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative" role="alert"><strong class="font-bold">Erreur R√©seau :</strong> <span class="block sm:inline">Impossible de contacter le serveur.</span></div>`;
        } finally {
            // R√©tablir le bouton en cas d'erreur
            uploadButton.disabled = false;
            uploadButton.textContent = 'Importer et R√©initialiser la Liste';
            uploadButton.classList.remove('bg-gray-400');
            uploadButton.classList.add('bg-indigo-600', 'hover:bg-indigo-700');
        }
    });


    // GESTION DES STATUTS (Election, Vote, Candidature, Visibilit√©)
    async function toggleVoting(action) {
        if (action === 'finalise_election' && !confirm("√ätes-vous s√ªr de vouloir FINALISER l'√©lection ? Cette action est irr√©versible et cl√¥ture d√©finitivement le vote.")) {
            return;
        }

        try {
            const response = await fetch('/api/admin/toggle_setting', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ action: action })
            });

            const data = await response.json();

            if (!response.ok) {
                alert('Erreur: ' + (data.error || '√âchec de l\'op√©ration.'));
            } else {
                alert(data.success);
                window.location.reload();
            }

        } catch (error) {
            alert('Erreur r√©seau.');
        }
    }

    // GESTION DES CANDIDATS (VALIDER/SUPPRIMER)
    async function candidateAction(candidateId, action) {
        if (action === 'delete' && !confirm("√ätes-vous s√ªr de vouloir supprimer ce candidat ? Cette action est irr√©versible et supprime la photo.")) {
            return;
        }

        try {
            const response = await fetch(`/api/admin/candidate_action/${candidateId}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ action: action })
            });

            const data = await response.json();

            if (!response.ok) {
                alert('Erreur: ' + (data.error || '√âchec de l\'op√©ration.'));
            } else {
                alert(data.success);
                window.location.reload();
            }
        } catch (error) {
            alert('Erreur r√©seau.');
        }
    }
</script>
{% endblock %}